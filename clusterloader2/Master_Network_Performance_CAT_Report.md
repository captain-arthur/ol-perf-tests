# 🚀 통합 마스터 가이드: K8s 네트워크 성능 검증 (PoC & CAT) 완전 정복

본 문서는 신규 쿠버네티스(K8s) 클러스터를 구축한 후 네트워크 인프라가 요구사항을 만족하는지 검증하기 위한 **클러스터 인수 테스트(CAT: Cluster Acceptance Test)**의 핵심 지침이자, **ClusterLoader2** 프레임워크를 활용한 네트워크 대역폭(Throughput) 측정 PoC의 최종 통합 보고서입니다.

테스트의 기준, 아키텍처 내부 동작 원리, 실행 제어 옵션의 엔지니어링 뎁스, 그리고 현재 직면한 기술 부채까지 한 권의 백서로 엮어 비전문가부터 전문 엔지니어까지 모두가 이해할 수 있도록 구성했습니다.

---

## 🏗 [Part 1] 배경지식: 네트워크 성능 테스트의 철학 (왜 측정하는가?)

K8s 네트워크를 이해하기 전, 전문 용어들을 쉽게 일상에 빗대어 살펴봅니다.

### 1-1. "L3/L4 계층 망" (우리가 측정하는 대상)
- **비유:** 순수하게 아스팔트가 깔린 **고속도로의 차선 넓이** 그 자체입니다. 트럭(패킷)이 1초에 몇 대나 지나갈 수 있는지만 가혹하게 밀어붙여 측정합니다.
- **의미:** 우리 클러스터 내부 신경망(CNI: Container Network Interface, 예: Calico, Cilium, Flannel)이 기본적으로 낼 수 있는 물리적/논리적 뼈대 대역폭 체력(Baseline)을 의미합니다.

### 1-2. "L7 / Ingress 프록시" (우리가 배제한 대상)
- **비유:** 톨게이트 요금소 직원이나 도착지의 깐깐한 택배 검수소입니다. 트럭이 오면 목적지 URL이 맞는지, 바이러스는 없는지(보안 검사/HTTPS 인증서 복호화) 바코드를 띡띡 스캔하는 "무거운 비즈니스 처리 과정"입니다.
- **의미:** 사내 API 서버 로직, DB 병목, 로드밸런서의 라우팅 오버헤드 등입니다. 고속도로(L3/L4 망)가 아무리 넓어도 여기서 느려지면 사용자는 "느리다"고 불평합니다.

### 1-3. 테스트의 궁극적 목적 (Baseline 증명의 힘)
사용자들이 "게시판이 너무 느려요!"라고 할 때, 이게 **"톨게이트 직원 손이 느려서(앱 로봇 버그/DB 락)"** 인지, 애초에 **"고속도로가 2차선 밖에 안돼서(진짜 네트워크 인프라 문제)"** 인지 명확히 분간해야 합니다.
이 테스트는 톨게이트 검사를 싹 다 무시하고 깡통 트럭만 무한대로 쏘아 보내, **"우리의 도로망은 원래 20Gbps로 완벽하게 뻥 뚫려있다"는 확정 데이터(방패)**를 얻어내는 과정입니다.

---

## 🎯 [Part 2] 인수 테스트(CAT) 실무: 무엇을 합격 기준으로 삼는가?

신규 클러스터 네트워크를 오픈하기 전 검증해야 할 핵심 지표 3가지입니다.

1. **대역폭 (Bandwidth / Throughput)**
   - **의미:** 클러스터 내부 노드 간 "초당 얼마나 많은 데이터를 꽂아 넣을 수 있는가?" (TCP 프로토콜)
   - **평가 기준 예시:** "동일 Zone 내 파드 간 통신 90% 백분위 최소 5Gbits/sec 보장"
2. **지연 시간 (Latency / Response Time)**
   - **의미:** 데이터를 요쳥했을 때 "얼마나 즉각적으로 응답이 돌아오는가?" (HTTP 프로토콜)
   - **평가 기준 예시:** "최대 부하 상태에서 HTTP GET 요청의 99% 응답 시간이 10ms 이하일 것"
3. **패킷 손실률 및 지터 (Packet Loss & Jitter)**
   - **의미:** "유실되는 데이터는 없는가? 연결이 요동치지는 않는가?" (UDP 프로토콜)

---

## 🛠 [Part 3] ClusterLoader2 아키텍처 딥다이브: 군대식 오케스트레이션

구글이 공식 지원하는 대규모 K8s 벤치마킹 툴인 `ClusterLoader2`는 어떻게 수천 개의 파드를 동시다발적으로 통제할까요?
(통신사에서 100만 대의 무전기를 동시에 테스트하는 상황을 떠올려 보십시오.)

### 3-1. 핵심 무기 `iperf`
실제 대역폭을 측정하는 네트워크 엔진입니다. 서버(수신부)와 클라이언트(송신부)로 나뉘어 거대한 더미 데이터를 쏟아붓는 표준 검증 도구입니다. 최신 버전 3(단일 코어 동작) 대신, 멀티 코어를 쥐어짜 극단적 트래픽 한방울까지 뽑아내는 기능 때문에 **버전 2.0.x**가 컨테이너 이미지(`netperfbenchmark`) 내부에 이식되어 있습니다.

### 3-2. 스케줄링(짝짓기) 및 동기화 (Time-Sync)
무전기 50개를 마구잡이로 누르면 한계 응력을 잴 수 없습니다.
1. 지휘관(Go 코드)은 노드들에 파드를 골고루 살포해 배포합니다.
2. 이후 동일 노드 내 회귀 모의 패킷 전송을 막기 위해 힙(Heap) 정렬 알고리즘을 사용해 **반드시 물리적으로 서로 다른 노드에 뜬 클라이언트와 서버를 1:1로 매칭**시킵니다.
3. **미래 발사 동기화:** CRD(Custom Resource Definition)라는 K8s 전용 커스텀 게시판을 만들어 "*너는 10.244.x.y 로, 정확히 15시 00분 15초(유닉스 타임)에 다 같이 쏴라!*"고 정밀 시계 알람을 맞춰 전달합니다.

### 3-3. 성적표 취합 (`gather` 액션) 흐름
1. `iperf` 실행이 끝난 파드 내의 스크립트는 쉘 실행 결과(Mbits/sec 텍스트)를 JSON으로 파싱합니다.
2. 파드는 자신의 지시서가 적힌 API 서버의 빈칸(CRD의 `status` 필드)에 결괏값을 직접 `PATCH(수정)`하여 적어 냅니다.
3. 밖에서 기다리던 ClusterLoader2는 성적표가 다 모이면 평균/백분위를 내어 터미널과 JUnit XML 파일로 최종 보고서를 산출합니다.

---

## 💻 [Part 4] 실전 실행 가이드 및 `--provider` 옵션의 숨겨진 실체

이 도구는 단순한 API 찌르기 봇이 아닙니다. K8s 한계돌파 파괴 테스트(`NodeKiller`, OOM 긁어오기 등)를 위해 K8s API를 무시하고 깡통 서버 리눅스 OS(커널) 밑단까지 강제로 침투(`RunSSHCommand`)하는 백도어 코드를 품고 있습니다. 

### 4-1. CLI 실행 명령어 (기본)
```bash
./clusterloader2 \
  --kubeconfig=$HOME/.kube/config \
  --testconfig=testing/network/config.yaml \
  --testoverrides=testing/network/tcp_protocol_override.yaml \
  --testoverrides=testing/network/1_1_ratio_override.yaml \
  --provider=skeleton \
  --report-dir=test_results \
  --v=2
```

### 4-2. `--provider` 옵션별 치열한 엔지니어링 뎁스 로직
명령어에서 가장 중요한, 인프라 환경별 **"기능(Feature Flag)" 및 "SSH 라우팅" 설정 스위치**입니다.

* **`--provider=local` (단일 머신 강제):** K8s 마스터가 랩탑(`localhost`)에 있다고 가정하여, `[LOCAL_SSH_KEY]` 환경 변수를 이용해 현재 PC에 다이렉트 SSH 터미널 접속을 시도하게 하드코딩 되어있습니다. 다중 노드 통신망 테스트 시 구조적으로 뻗어버릴 수 있습니다.
* **`--provider=kind` (도커 컨테이너 모드):** Kind는 컨테이너라 깡통 SSH 데몬 포트 자체가 없기 때문에 SSH 기능을 원천적으로 꺼버립니다. (향후 필요시 `docker exec` 우회 접속을 예고하는 주석만 코딩되어 있음). 
* **`--provider=aws`, `gce` 등:** 클라우드 벤더사 고유 키(`.ssh/google_compute_engine` 등)와 프라이빗 로드밸런서 타임아웃 룰을 타도록 특화된 로직입니다.
* **🌟 `--provider=skeleton` (원격 / 운영 클러스터 타겟 최적화 모드):**
  클라우드 종속성이 완전히 제거된 가장 "표준적이고 중립적인 완전 깡통 뼈대"입니다. **사내 온프레미스 장비나 타겟 클러스터를 향해 단순 `kubeconfig` 명령어 권한만 들고 네트워크 스케줄링 테스트를 무사고로 돌리려면 `skeleton`이 가장 공식적이고 안전한 강력 권장 옵션입니다.**

---

## ⚠️ [Part 5] 트러블슈팅 및 현재 프레임워크 기술 부채 (Known Issues)

해당 공식 오픈소스 리포지토리의 원본 템플릿 코드에는, 현재 버전 기준 **기본적인 테스트 실행을 가로막는 치명적인 버그(기술 부채)**가 존재합니다. 

### 5-1. YAML 파싱 및 CRD 스펙 호환성 버그 (설계 결함)
* **현상:** 명령을 실행하면 0단계 파드 배포 직전 `TemplateToObject error: replacing placeholders error: Invalid YAML Template` 이라는 에러와 함께 멈춥니다.
* **원인:** `manifests/networktestrequests.yaml`에서 인라인 객체 파싱을 시작하는 중괄호 특수문자(`{}`)를 Key 값에 따옴표(`""`) 없이 문법적으로 잘못 쌩으로 박아두어 파서가 터지는 버그입니다. 설령 그것을 고치더라도 현재 K8s API 서버(1.20+)의 Validation 스펙상 객체 생성 시 필수인 `status: metrics: []` 빈칸 배열 구조를 명시하지 않고 누락해둔 치명적 결함이 공존합니다. 
* **대처법:** 원본 리포지토리 코드를 롤백한 상태에서는 절대 구동되지 않으며, `networktestrequests.yaml`의 문법 수정과 `status` 영역 보강을 거치는 **최소한의 마이크로 패치(Fix 커밋)**가 수반되어야만 정상 테스트가 가능합니다. 

### 5-2. `Failed to receive response` 에러 및 Throughput 0 반환
* **현상:** 테스트가 성공적으로 동작하는 듯하다가 채점 결과에 대역폭 값이 **`0`** 점으로 나옵니다.
* **원인:** RBAC(권한 제어) 누락입니다. 파드(`netperfbenchmark`) 내부 쉘 스크립트가 iperf 성적을 냈으나, K8s 게시판(API 서버의 CRD)에 자신의 성적을 수정(`PATCH`)해 덮어쓸 ServiceAccount(롤바인딩) 토큰 인가 권한을 획득하지 못해(403 Forbidden) 밖에서 기다리던 지휘관에게 응답을 건네주지 못한 현상입니다. 

---

## 📊 [Part 6] PoC 최종 대역폭 검증 결과 및 의의

모든 버그를 극복하고 진행한 PoC 결과, 우리는 성공적으로 기준점(Baseline)을 확립했습니다. 

1. **단위 환산의 이해**
   - 수집된 원본 수치: `2,654,989 kbytes/sec` (초당 영화 한 편 전송 가능 용량)
   - 통신망 체급 환산치: 이 수치는 컴퓨터 데이터 속도 기준 **약 2.65 GB/s**이며, 네트워크 대역폭(통신 회선) 기준 **약 21 Gbps 광랜급**의 거대한 한계 차선폭입니다.
2. **실무 적용의 든든한 방패**
   향후 데이터 파이프라인(Hadoop/Kafka 등 막대한 데이터 노드) 사업 수주 시 혹은 서비스 지연 시, 앱과 분리된 이 테스트 결과를 바탕으로 **"우리 클러스터 인프라는 최소 21Gbps 트래픽 쓰나미 상황에서도 끄떡없이 뚫려있음을 CAT로 완벽 검증했다"** 라고 데이터로 확신 있게 소통할 수 있는 인프라 무기가 확보되었습니다. 

---
**[문서 끝]**
