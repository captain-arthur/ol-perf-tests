# 📋 ClusterLoader2 네트워크 테스트 트러블슈팅 및 사후 분석 보고서

본 문서는 ClusterLoader2(CL2) 프레임워크를 활용한 네트워크 성능 측정 PoC 과정에서 발생한 주요 장애와 그 기술적 배경, 그리고 이를 해결하기 위해 적용된 패치 내역을 상세히 기록합니다.

---

## 1. 발생한 주요 문제 및 현상

테스트 재현 시 다음과 같은 세 가지 핵심 레이어에서 문제가 발생하여 정상적인 측정이 불가능했습니다.

| 문제 유형 | 현상 | 영향 |
| :--- | :--- | :--- |
| **구문 및 엔진 오류** | `Invalid YAML Template` 에러 발생 및 실행 즉시 중단 | 테스트 시작 자체가 불가능함 |
| **권한 결함 (RBAC)** | 테스트는 동작하나 결과 값이 `0` (Throughput: 0)으로 수집됨 | 측정 데이터 유실 및 결과 요약 실패 |
| **설계 결함 (성능)** | 대역폭 수치가 네트워크 실제 체급(광랜)에 비해 현저히 낮게 측정됨 | 인프라의 실제 성능(Baseline) 증명 불가능 |

---

## 2. 근본 원인 분석 (Root Cause Analysis)

### 2-1. `safetext` 라이브러리 도입과 보안 제약 (가장 치명적 원인)
쿠버네티스 커뮤니티는 최근 YAML 인젝션 공격을 방어하기 위해 모든 템플릿 엔진에 `github.com/google/safetext/yamltemplate`을 도입했습니다.
*   **원인**: 기존 `text/template`은 자유로운 텍스트 치환이 가능했으나, `safetext`는 **YAML의 구조(키 값 등)를 동적으로 변경하는 것을 엄격히 금지**합니다.
*   **분석**: CL2 원본 코드의 `networktestrequests.yaml`은 레이블 키에 `{{.clientPodName}}`을 그대로 사용하고 있었습니다. 이는 보안 정책상 "잠재적 인젝션 위험"으로 간주되어 파서 수준에서 거부된 것입니다.

### 2-2. Upstream 코드의 기술 부채 및 관리 실태
"쿠버네티스 오픈소스를 믿을 수 없는가?"라는 질문에 대한 엔지니어링 답변은 다음과 같습니다.
*   **관리 실태**: ClusterLoader2는 버려진 프로젝트는 아니지만, **"SIG-Scalability(확장성 특수이익집단)"**에 의해 매우 보수적이고 인프라 의존적으로 관리됩니다.
*   **부채의 이유**: 구글 내부 인프라(GCE 등) 위주로 테스트되다 보니, 중립적인 환경(Skeleton provider)이나 고도화된 RBAC 환경에서의 예외 케이스(예: 매니페스트 오타, 권한 누락)가 메인 코드에 방시되는 경우가 잦습니다. 즉, **"동작은 하지만, 범용 환경에서의 친절함은 부족한 전문 도구"**의 특성을 가집니다.

---

## 3. 해결 방안 (Solution)

문제를 해결하기 위해 적용된 '마이크로 패치' 내역입니다.

### 3-1. `StructuralData` 함수를 통한 보안 우회 (Code-based Patch)
`safetext`의 제약을 준수하면서 동적 키를 사용하기 위해 전용 헬퍼 함수를 적용했습니다.
```yaml
# AS-IS (Error)
labels:
  {{.clientPodName}}: clientPodName

# TO-BE (Fixed)
labels:
  {{ (StructuralData .clientPodName) }}: clientPodName
```
이 방식은 "이 값은 구조적으로 안전함"을 명시적으로 선언하여 보안 파서를 통과시킵니다.

### 3-2. RBAC 명시 및 리소스 최적화
*   **ServiceAccount**: 워커 파드에 `serviceAccountName: default`를 명시하여 API 서버에 성적표를 제출할 권한을 확립했습니다.
*   **CPU 리소스 부스트**: 대역폭 측정 엔진인 `iperf`가 고속도로를 꽉 채울 수 있도록 CPU 제한을 `500m` → `2000m`로 상향하여 병목 현상을 제거했습니다.

---

## 4. 결론 및 제언

ClusterLoader2는 여전히 쿠버네티스 성능 테스트의 **사실상의 표준(De-facto Standard)**입니다. 하지만 업스트림 코드가 모든 환경을 완벽히 커버하지 못하므로, 본 PoC에서 확인된 것처럼 **인프라 환경에 맞는 "현지화 패치"는 필수적**입니다.

우리는 이번 과정을 통해 단순한 툴 사용을 넘어, 쿠버네티스 내부 보안 정책 변화(`safetext`)와 RBAC 구조를 깊이 있게 파악하며 **"약 21 Gbps(최근 재현 결과 4.8 GB/s)"라는 신뢰할 수 있는 데이터**를 확보했습니다.

---
**작성일**: 2026-02-23
**상태**: 검증 완료 (Verified)
